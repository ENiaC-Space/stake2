<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENiAC Token - Stake & Farm</title>
    <meta name="description" content="Stake ENiAC tokens and earn rewards">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ñ</text></svg>">
    
    <!-- CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ƒê√£ bao g·ªìm to√†n b·ªô CSS t·ª´ code tr∆∞·ªõc */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: linear-gradient(135deg, #0f172a, #1e293b); color: #f1f5f9; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid #334155; margin-bottom: 30px; flex-wrap: wrap; }
        .logo { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .logo i { font-size: 2.5rem; color: #3b82f6; }
        .logo h1 { font-size: 1.8rem; background: linear-gradient(to right, #60a5fa, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .wallet-section { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .wallet-info { background: rgba(30, 41, 59, 0.7); padding: 10px 15px; border-radius: 12px; border: 1px solid #475569; font-size: 0.85rem; }
        .connect-btn { background: linear-gradient(to right, #3b82f6, #1d4ed8); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 0.9rem; }
        .connect-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4); }
        .connect-btn.connected { background: linear-gradient(to right, #10b981, #059669); }
        .main-content { display: grid; grid-template-columns: 1fr; gap: 30px; }
        @media (min-width: 768px) { .main-content { grid-template-columns: 1fr 1fr; } }
        .card { background: rgba(30, 41, 59, 0.7); border-radius: 20px; padding: 20px; border: 1px solid #475569; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); margin-bottom: 20px; }
        .card-title { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; font-size: 1.3rem; color: #60a5fa; }
        .card-title i { font-size: 1.5rem; }
        .stake-info { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .info-item { background: rgba(15, 23, 42, 0.5); padding: 12px; border-radius: 12px; border-left: 4px solid #3b82f6; }
        .info-label { font-size: 0.85rem; color: #94a3b8; margin-bottom: 5px; }
        .info-value { font-size: 1.1rem; font-weight: 600; color: #f1f5f9; word-break: break-all; }
        .input-group { margin-bottom: 20px; }
        .input-label { display: flex; justify-content: space-between; margin-bottom: 8px; color: #94a3b8; font-size: 0.9rem; }
        .balance { font-size: 0.85rem; }
        .input-wrapper { display: flex; border: 1px solid #475569; border-radius: 12px; overflow: hidden; background: rgba(15, 23, 42, 0.5); }
        .input-wrapper input { flex: 1; background: transparent; border: none; padding: 12px; color: white; font-size: 1rem; outline: none; }
        .max-btn { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: none; padding: 0 15px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 0.9rem; }
        .max-btn:hover { background: rgba(59, 130, 246, 0.4); }
        .action-buttons { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 25px; }
        @media (min-width: 480px) { .action-buttons { grid-template-columns: 1fr 1fr; } }
        .btn { padding: 14px; border-radius: 12px; border: none; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.3s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(to right, #10b981, #059669); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4); }
        .btn-secondary { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
        .btn-secondary:hover:not(:disabled) { background: rgba(239, 68, 68, 0.3); transform: translateY(-2px); }
        .btn-claim { background: linear-gradient(to right, #f59e0b, #d97706); color: white; }
        @media (min-width: 480px) { .btn-claim { grid-column: span 2; } }
        .btn-claim:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4); }
        .pool-list { margin-top: 20px; }
        .pool-item { background: rgba(15, 23, 42, 0.5); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #475569; transition: all 0.3s; }
        .pool-item:hover { border-color: #3b82f6; transform: translateY(-2px); }
        .pool-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .pool-name { display: flex; align-items: center; gap: 8px; font-size: 1.1rem; font-weight: 600; margin-bottom: 5px; }
        .pool-apy { background: rgba(34, 197, 94, 0.2); color: #4ade80; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .pool-details { display: grid; grid-template-columns: 1fr; gap: 10px; font-size: 0.85rem; margin-bottom: 15px; }
        @media (min-width: 480px) { .pool-details { grid-template-columns: repeat(2, 1fr); } }
        .detail-item span:first-child { color: #94a3b8; display: block; margin-bottom: 3px; }
        .pool-actions { display: flex; gap: 10px; margin-top: 15px; }
        .pool-btn { flex: 1; padding: 8px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.85rem; }
        .pool-deposit { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .pool-withdraw { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .pool-btn:hover:not(:disabled) { transform: translateY(-2px); }
        .pool-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #334155; color: #94a3b8; font-size: 0.85rem; }
        .contract-info { display: flex; justify-content: center; gap: 20px; margin-top: 15px; flex-wrap: wrap; }
        .contract-link { color: #60a5fa; text-decoration: none; display: flex; align-items: center; gap: 5px; font-size: 0.8rem; }
        .contract-link:hover { text-decoration: underline; }
        .loading { text-align: center; padding: 20px; color: #94a3b8; }
        .error-message { background: rgba(239, 68, 68, 0.2); color: #f87171; padding: 15px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #ef4444; }
        .notification { position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); display: none; z-index: 1000; max-width: 300px; font-size: 0.9rem; }
        .notification.error { background: #ef4444; }
        .notification.warning { background: #f59e0b; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 999; padding: 20px; }
        .modal { background: #1e293b; border-radius: 20px; padding: 25px; max-width: 500px; width: 100%; border: 1px solid #475569; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer; padding: 5px; }
        .tx-status { display: flex; align-items: center; gap: 10px; margin-top: 20px; padding: 10px; border-radius: 8px; background: rgba(59, 130, 246, 0.1); }
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(59, 130, 246, 0.3); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .instructions { background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #3b82f6; font-size: 0.9rem; }
        .instructions h3 { color: #60a5fa; margin-bottom: 10px; }
        .instructions ul { padding-left: 20px; }
        .instructions li { margin-bottom: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-server"></i>
                <h1>ENiAC Staking</h1>
            </div>
            <div class="wallet-section">
                <div class="wallet-info">
                    <div>Network: <span id="network-name">Not Connected</span></div>
                    <div>Account: <span id="wallet-address">Not Connected</span></div>
                </div>
                <button class="connect-btn" id="connect-wallet">
                    <i class="fas fa-wallet"></i> Connect Wallet
                </button>
            </div>
        </div>

        <!-- Instructions -->
        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> How to Use</h3>
            <ul>
                <li>Make sure you have MetaMask installed in your browser</li>
                <li>Connect to Ethereum Mainnet</li>
                <li>You need ETH for transaction fees</li>
                <li>First approve, then stake your ENiAC tokens</li>
            </ul>
        </div>

        <div class="main-content">
            <!-- Stake Card -->
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-coins"></i>
                    <h2>Stake ENiAC Tokens</h2>
                </div>
                
                <div class="stake-info">
                    <div class="info-item">
                        <div class="info-label">ENiAC Balance</div>
                        <div class="info-value" id="eniac-balance">0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Your Staked</div>
                        <div class="info-value" id="user-staked">0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">APY</div>
                        <div class="info-value" id="apy">--%</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Pending Rewards</div>
                        <div class="info-value" id="pending-rewards">0</div>
                    </div>
                </div>

                <div class="input-group">
                    <div class="input-label">
                        <span>Amount to Stake</span>
                        <span class="balance">Balance: <span id="available-balance">0</span> ENiAC</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="number" id="stake-amount" placeholder="0.0" min="0" step="0.0001">
                        <button class="max-btn" id="max-stake">MAX</button>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="approve-stake" disabled>
                        <i class="fas fa-check-circle"></i> Approve
                    </button>
                    <button class="btn btn-primary" id="stake-tokens" disabled>
                        <i class="fas fa-lock"></i> Stake
                    </button>
                    <button class="btn btn-secondary" id="unstake-tokens" disabled>
                        <i class="fas fa-unlock"></i> Unstake
                    </button>
                    <button class="btn btn-claim" id="claim-rewards" disabled>
                        <i class="fas fa-gift"></i> Claim Rewards
                    </button>
                </div>
            </div>

            <!-- Farming Pools Card -->
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-tractor"></i>
                    <h2>Farming Pools</h2>
                </div>

                <div class="pool-list" id="pool-list">
                    <div class="loading" id="pools-loading">
                        <i class="fas fa-spinner fa-spin"></i> Connect wallet to view pools...
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction Modal -->
        <div class="modal-overlay" id="tx-modal">
            <div class="modal">
                <div class="modal-header">
                    <h3 id="modal-title">Transaction</h3>
                    <button class="modal-close" id="modal-close">&times;</button>
                </div>
                <div id="modal-content">
                    <p id="modal-message">Processing transaction...</p>
                    <div class="tx-status" id="tx-status">
                        <div class="spinner"></div>
                        <span>Waiting for confirmation...</span>
                    </div>
                    <div id="tx-hash" style="margin-top: 15px; font-size: 0.85rem; word-break: break-all;"></div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>ENiAC Staking Platform - Secure and Efficient Yield Farming</p>
            <div class="contract-info">
                <a href="https://etherscan.io/address/0xafF339de48848d0F8B5704909Ac94e8E8D7E3415" target="_blank" class="contract-link">
                    <i class="fas fa-file-contract"></i> ENiAC Token Contract
                </a>
                <a href="https://etherscan.io/address/0x564DF71B75855d63c86a267206Cd0c9e35c92789" target="_blank" class="contract-link">
                    <i class="fas fa-chess-queen"></i> MasterChef Contract
                </a>
                <a href="https://etherscan.io/address/0x1d30e4a1357C6e9ee2a983348aFDb558A1BD2976" target="_blank" class="contract-link">
                    <i class="fas fa-vault"></i> Vault Contract
                </a>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <!-- Ethers.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.0/dist/ethers.umd.min.js"></script>
    
    <script>
        // Contract addresses (Mainnet)
        const ENIAC_TOKEN_ADDRESS = "0xafF339de48848d0F8B5704909Ac94e8E8D7E3415";
        const MASTERCHEF_ADDRESS = "0x564DF71B75855d63c86a267206Cd0c9e35c92789";
        const VAULT_ADDRESS = "0x1d30e4a1357C6e9ee2a983348aFDb558A1BD2976";

        // Contract ABIs (simplified)
        const ENIAC_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)"
        ];

        const MASTERCHEF_ABI = [
            "function poolLength() view returns (uint256)",
            "function poolInfo(uint256) view returns (address lpToken, uint256 allocPoint, uint256 lastRewardBlock, uint256 accANTPerShare)",
            "function userInfo(uint256, address) view returns (uint256 amount, uint256 rewardDebt)",
            "function pendingANT(uint256 _pid, address _user) view returns (uint256)",
            "function deposit(uint256 _pid, uint256 _amount)",
            "function withdraw(uint256 _pid, uint256 _amount)",
            "function ANT() view returns (address)"
        ];

        // Global variables
        let provider = null;
        let signer = null;
        let userAddress = null;
        let eniacContract = null;
        let masterchefContract = null;

        // DOM Elements
        const connectWalletBtn = document.getElementById('connect-wallet');
        const walletAddressEl = document.getElementById('wallet-address');
        const networkNameEl = document.getElementById('network-name');
        const eniacBalanceEl = document.getElementById('eniac-balance');
        const userStakedEl = document.getElementById('user-staked');
        const pendingRewardsEl = document.getElementById('pending-rewards');
        const availableBalanceEl = document.getElementById('available-balance');
        const stakeAmountInput = document.getElementById('stake-amount');
        const maxStakeBtn = document.getElementById('max-stake');
        const approveStakeBtn = document.getElementById('approve-stake');
        const stakeTokensBtn = document.getElementById('stake-tokens');
        const unstakeTokensBtn = document.getElementById('unstake-tokens');
        const claimRewardsBtn = document.getElementById('claim-rewards');
        const notificationEl = document.getElementById('notification');
        const txModal = document.getElementById('tx-modal');
        const modalClose = document.getElementById('modal-close');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const txHashEl = document.getElementById('tx-hash');
        const poolsLoading = document.getElementById('pools-loading');
        const poolListEl = document.getElementById('pool-list');

        // Initialize khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            initializeApp();
        });

        // Event Listeners
        connectWalletBtn.addEventListener('click', connectWallet);
        maxStakeBtn.addEventListener('click', setMaxStake);
        approveStakeBtn.addEventListener('click', approveStaking);
        stakeTokensBtn.addEventListener('click', stakeTokens);
        unstakeTokensBtn.addEventListener('click', unstakeTokens);
        claimRewardsBtn.addEventListener('click', claimRewards);
        modalClose.addEventListener('click', () => {
            txModal.style.display = 'none';
        });

        async function initializeApp() {
            console.log('Initializing app...');
            
            // Ki·ªÉm tra xem c√≥ MetaMask kh√¥ng
            if (typeof window.ethereum !== 'undefined') {
                console.log('MetaMask detected');
                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // Ki·ªÉm tra n·∫øu ƒë√£ k·∫øt n·ªëi tr∆∞·ªõc ƒë√≥
                try {
                    const accounts = await provider.listAccounts();
                    if (accounts.length > 0) {
                        console.log('Found cached account');
                        await setupConnection();
                    }
                } catch (error) {
                    console.log('No cached account found');
                }
                
                // L·∫Øng nghe s·ª± ki·ªán
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', handleChainChanged);
                
            } else {
                console.log('MetaMask not found');
                showNotification('Please install MetaMask to use this dApp!', 'warning');
                poolListEl.innerHTML = `
                    <div class="error-message">
                        <h4><i class="fas fa-exclamation-triangle"></i> MetaMask Required</h4>
                        <p>Please install MetaMask browser extension to use this dApp.</p>
                        <p><a href="https://metamask.io/download/" target="_blank" style="color: #60a5fa;">Download MetaMask here</a></p>
                    </div>
                `;
            }
        }

        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    showNotification('Please install MetaMask first!', 'warning');
                    return;
                }
                
                showTxModal('Connecting Wallet', 'Please approve the connection in MetaMask...');
                
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                await setupConnection();
                
                txModal.style.display = 'none';
                showNotification('Wallet connected successfully!', 'success');
                
            } catch (error) {
                console.error('Connection error:', error);
                txModal.style.display = 'none';
                
                if (error.code === 4001) {
                    showNotification('Connection rejected by user', 'warning');
                } else {
                    showNotification('Failed to connect: ' + error.message, 'error');
                }
            }
        }

        async function setupConnection() {
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                // L·∫•y network info
                const network = await provider.getNetwork();
                updateNetworkInfo(network);
                
                // Kh·ªüi t·∫°o contracts
                eniacContract = new ethers.Contract(ENIAC_TOKEN_ADDRESS, ENIAC_ABI, signer);
                masterchefContract = new ethers.Contract(MASTERCHEF_ADDRESS, MASTERCHEF_ABI, signer);
                
                // Update UI
                updateWalletInfo();
                enableButtons();
                
                // Load data
                await loadUserData();
                await loadPools();
                
                console.log('Setup completed successfully');
                
            } catch (error) {
                console.error('Setup error:', error);
                showNotification('Setup error: ' + error.message, 'error');
            }
        }

        function updateNetworkInfo(network) {
            const networkMap = {
                1: 'Ethereum Mainnet',
                5: 'Goerli Testnet',
                137: 'Polygon'
            };
            
            const networkName = networkMap[network.chainId] || `Chain ${network.chainId}`;
            networkNameEl.textContent = networkName;
        }

        function updateWalletInfo() {
            if (userAddress) {
                const shortAddress = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
                walletAddressEl.textContent = shortAddress;
                connectWalletBtn.innerHTML = '<i class="fas fa-check"></i> Connected';
                connectWalletBtn.classList.add('connected');
            }
        }

        function enableButtons() {
            approveStakeBtn.disabled = false;
            stakeTokensBtn.disabled = false;
            unstakeTokensBtn.disabled = false;
            claimRewardsBtn.disabled = false;
        }

        async function loadUserData() {
            try {
                if (!userAddress || !eniacContract || !masterchefContract) return;
                
                console.log('Loading user data...');
                
                // Load ENiAC balance
                const balance = await eniacContract.balanceOf(userAddress);
                const decimals = await eniacContract.decimals();
                const formattedBalance = ethers.utils.formatUnits(balance, decimals);
                eniacBalanceEl.textContent = parseFloat(formattedBalance).toFixed(4);
                availableBalanceEl.textContent = parseFloat(formattedBalance).toFixed(4);
                
                // Load staked amount v√† pending rewards
                try {
                    // Th·ª≠ pool 1 tr∆∞·ªõc
                    const userInfo = await masterchefContract.userInfo(1, userAddress);
                    const stakedAmount = ethers.utils.formatUnits(userInfo.amount, decimals);
                    userStakedEl.textContent = parseFloat(stakedAmount).toFixed(4);
                    
                    const pending = await masterchefContract.pendingANT(1, userAddress);
                    const pendingFormatted = ethers.utils.formatUnits(pending, decimals);
                    pendingRewardsEl.textContent = parseFloat(pendingFormatted).toFixed(4);
                    
                } catch {
                    // Th·ª≠ pool 0 n·∫øu pool 1 l·ªói
                    try {
                        const userInfo = await masterchefContract.userInfo(0, userAddress);
                        const stakedAmount = ethers.utils.formatUnits(userInfo.amount, decimals);
                        userStakedEl.textContent = parseFloat(stakedAmount).toFixed(4);
                        
                        const pending = await masterchefContract.pendingANT(0, userAddress);
                        const pendingFormatted = ethers.utils.formatUnits(pending, decimals);
                        pendingRewardsEl.textContent = parseFloat(pendingFormatted).toFixed(4);
                    } catch (e) {
                        console.log('Could not load pool data:', e);
                    }
                }
                
                // Check allowance
                const allowance = await eniacContract.allowance(userAddress, MASTERCHEF_ADDRESS);
                const allowanceFormatted = ethers.utils.formatUnits(allowance, decimals);
                
                if (parseFloat(allowanceFormatted) > 0) {
                    approveStakeBtn.innerHTML = '<i class="fas fa-check"></i> Approved';
                    approveStakeBtn.disabled = true;
                }
                
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function loadPools() {
            try {
                if (!userAddress || !masterchefContract) {
                    return;
                }
                
                poolsLoading.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading pools...</div>';
                
                // Get pool length
                const poolLength = await masterchefContract.poolLength();
                const numPools = poolLength.toNumber();
                
                if (numPools === 0) {
                    poolListEl.innerHTML = '<div class="error-message">No pools available</div>';
                    return;
                }
                
                let poolsHTML = '';
                const decimals = 18;
                
                // Load pools
                for (let i = 0; i < Math.min(3, numPools); i++) {
                    try {
                        const poolInfo = await masterchefContract.poolInfo(i);
                        const userInfo = await masterchefContract.userInfo(i, userAddress);
                        const pendingRewards = await masterchefContract.pendingANT(i, userAddress);
                        
                        let poolName = `Pool ${i}`;
                        let poolIcon = 'fa-coins';
                        
                        if (i === 0) {
                            poolName = "ENiAC-ETH LP";
                            poolIcon = "fa-water";
                        } else if (i === 1) {
                            poolName = "ENiAC Single";
                            poolIcon = "fa-gem";
                        }
                        
                        const stakedAmount = ethers.utils.formatUnits(userInfo.amount, decimals);
                        const rewards = ethers.utils.formatUnits(pendingRewards, decimals);
                        
                        poolsHTML += `
                            <div class="pool-item">
                                <div class="pool-header">
                                    <div class="pool-name">
                                        <i class="fas ${poolIcon}"></i> ${poolName}
                                    </div>
                                    <div class="pool-apy">APY: ${i === 0 ? '45.7%' : i === 1 ? '28.3%' : '15.2%'}</div>
                                </div>
                                <div class="pool-details">
                                    <div class="detail-item">
                                        <span>Your Stake</span>
                                        <span>${parseFloat(stakedAmount).toFixed(4)} ${i === 1 ? 'ENiAC' : 'LP'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span>Rewards</span>
                                        <span>${parseFloat(rewards).toFixed(4)} ENiAC</span>
                                    </div>
                                    <div class="detail-item">
                                        <span>Pool Share</span>
                                        <span>${(parseFloat(stakedAmount) > 0 ? "0.05%" : "0%")}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span>Multiplier</span>
                                        <span>${i === 0 ? "2x" : i === 1 ? "1x" : "1.5x"}</span>
                                    </div>
                                </div>
                                <div class="pool-actions">
                                    <button class="pool-btn pool-deposit" onclick="depositToPool(${i})">
                                        <i class="fas fa-plus"></i> Deposit
                                    </button>
                                    <button class="pool-btn pool-withdraw" onclick="withdrawFromPool(${i})">
                                        <i class="fas fa-minus"></i> Withdraw
                                    </button>
                                </div>
                            </div>
                        `;
                        
                    } catch (error) {
                        console.error(`Error loading pool ${i}:`, error);
                    }
                }
                
                poolsLoading.style.display = 'none';
                poolListEl.innerHTML = poolsHTML;
                
            } catch (error) {
                console.error('Error loading pools:', error);
                poolListEl.innerHTML = '<div class="error-message">Error loading pools</div>';
            }
        }

        function setMaxStake() {
            const availableBalance = parseFloat(availableBalanceEl.textContent);
            if (!isNaN(availableBalance) && availableBalance > 0) {
                stakeAmountInput.value = availableBalance;
            }
        }

        async function approveStaking() {
            try {
                if (!userAddress) {
                    showNotification('Please connect your wallet first!', 'warning');
                    return;
                }
                
                const amount = stakeAmountInput.value;
                if (!amount || parseFloat(amount) <= 0) {
                    showNotification('Please enter a valid amount!', 'warning');
                    return;
                }
                
                showTxModal('Approve ENiAC', 'Please approve the transaction in your wallet...');
                
                const decimals = await eniacContract.decimals();
                const amountWei = ethers.utils.parseUnits(amount, decimals);
                
                const tx = await eniacContract.approve(MASTERCHEF_ADDRESS, amountWei);
                
                modalMessage.textContent = 'Transaction submitted. Waiting for confirmation...';
                txHashEl.innerHTML = `Tx Hash: <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" style="color: #60a5fa;">${tx.hash.substring(0, 20)}...</a>`;
                
                const receipt = await tx.wait();
                
                if (receipt.status === 1) {
                    modalMessage.textContent = 'Approval successful!';
                    setTimeout(() => {
                        txModal.style.display = 'none';
                        showNotification('Tokens approved for staking!', 'success');
                        loadUserData();
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Approval error:', error);
                modalMessage.textContent = 'Error: ' + error.message;
                setTimeout(() => {
                    txModal.style.display = 'none';
                    showNotification('Approval failed: ' + error.message, 'error');
                }, 3000);
            }
        }

        async function stakeTokens() {
            try {
                if (!userAddress) {
                    showNotification('Please connect your wallet first!', 'warning');
                    return;
                }
                
                const amount = stakeAmountInput.value;
                if (!amount || parseFloat(amount) <= 0) {
                    showNotification('Please enter a valid amount!', 'warning');
                    return;
                }
                
                showTxModal('Stake ENiAC', 'Please confirm the stake transaction...');
                
                const decimals = await eniacContract.decimals();
                const amountWei = ethers.utils.parseUnits(amount, decimals);
                
                // Check allowance
                const allowance = await eniacContract.allowance(userAddress, MASTERCHEF_ADDRESS);
                if (allowance.lt(amountWei)) {
                    showNotification('Please approve tokens first!', 'warning');
                    txModal.style.display = 'none';
                    return;
                }
                
                // Try pool 1, fallback to 0
                let poolId = 1;
                try {
                    await masterchefContract.poolInfo(poolId);
                } catch {
                    poolId = 0;
                }
                
                const tx = await masterchefContract.deposit(poolId, amountWei);
                modalMessage.textContent = 'Transaction submitted. Waiting for confirmation...';
                txHashEl.innerHTML = `Tx Hash: <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" style="color: #60a5fa;">${tx.hash.substring(0, 20)}...</a>`;
                
                const receipt = await tx.wait();
                
                if (receipt.status === 1) {
                    modalMessage.textContent = 'Stake successful!';
                    setTimeout(() => {
                        txModal.style.display = 'none';
                        showNotification(`Successfully staked ${amount} ENiAC!`, 'success');
                        stakeAmountInput.value = '';
                        loadUserData();
                        loadPools();
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Stake error:', error);
                modalMessage.textContent = 'Error: ' + error.message;
                setTimeout(() => {
                    txModal.style.display = 'none';
                    showNotification('Stake failed: ' + error.message, 'error');
                }, 3000);
            }
        }

        async function unstakeTokens() {
            try {
                if (!userAddress) {
                    showNotification('Please connect your wallet first!', 'warning');
                    return;
                }
                
                const amount = stakeAmountInput.value;
                if (!amount || parseFloat(amount) <= 0) {
                    showNotification('Please enter a valid amount!', 'warning');
                    return;
                }
                
                showTxModal('Unstake ENiAC', 'Please confirm the unstake transaction...');
                
                const decimals = await eniacContract.decimals();
                const amountWei = ethers.utils.parseUnits(amount, decimals);
                
                let poolId = 1;
                try {
                    await masterchefContract.poolInfo(poolId);
                } catch {
                    poolId = 0;
                }
                
                const tx = await masterchefContract.withdraw(poolId, amountWei);
                modalMessage.textContent = 'Transaction submitted. Waiting for confirmation...';
                txHashEl.innerHTML = `Tx Hash: <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" style="color: #60a5fa;">${tx.hash.substring(0, 20)}...</a>`;
                
                const receipt = await tx.wait();
                
                if (receipt.status === 1) {
                    modalMessage.textContent = 'Unstake successful!';
                    setTimeout(() => {
                        txModal.style.display = 'none';
                        showNotification(`Successfully unstaked ${amount} ENiAC!`, 'success');
                        stakeAmountInput.value = '';
                        loadUserData();
                        loadPools();
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Unstake error:', error);
                modalMessage.textContent = 'Error: ' + error.message;
                setTimeout(() => {
                    txModal.style.display = 'none';
                    showNotification('Unstake failed: ' + error.message, 'error');
                }, 3000);
            }
        }

        async function claimRewards() {
            try {
                if (!userAddress) {
                    showNotification('Please connect your wallet first!', 'warning');
                    return;
                }
                
                showTxModal('Claim Rewards', 'Please confirm the claim transaction...');
                
                let poolId = 1;
                let pending;
                
                try {
                    pending = await masterchefContract.pendingANT(poolId, userAddress);
                } catch {
                    poolId = 0;
                    pending = await masterchefContract.pendingANT(poolId, userAddress);
                }
                
                if (pending.eq(0)) {
                    showNotification('No rewards to claim!', 'warning');
                    txModal.style.display = 'none';
                    return;
                }
                
                const tx = await masterchefContract.withdraw(poolId, 0);
                modalMessage.textContent = 'Transaction submitted. Waiting for confirmation...';
                txHashEl.innerHTML = `Tx Hash: <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" style="color: #60a5fa;">${tx.hash.substring(0, 20)}...</a>`;
                
                const receipt = await tx.wait();
                
                if (receipt.status === 1) {
                    modalMessage.textContent = 'Rewards claimed successfully!';
                    setTimeout(() => {
                        txModal.style.display = 'none';
                        showNotification('Rewards claimed successfully!', 'success');
                        loadUserData();
                        loadPools();
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Claim error:', error);
                modalMessage.textContent = 'Error: ' + error.message;
                setTimeout(() => {
                    txModal.style.display = 'none';
                    showNotification('Claim failed: ' + error.message, 'error');
                }, 3000);
            }
        }

        function depositToPool(poolId) {
            showNotification(`Deposit to Pool ${poolId} feature coming soon!`, 'warning');
        }

        function withdrawFromPool(poolId) {
            showNotification(`Withdraw from Pool ${poolId} feature coming soon!`, 'warning');
        }

        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                // Disconnected
                userAddress = null;
                walletAddressEl.textContent = 'Not Connected';
                connectWalletBtn.innerHTML = '<i class="fas fa-wallet"></i> Connect Wallet';
                connectWalletBtn.classList.remove('connected');
                showNotification('Wallet disconnected', 'warning');
            } else {
                // Changed account
                userAddress = accounts[0];
                setupConnection();
            }
        }

        function handleChainChanged() {
            // Reload page on chain change
            window.location.reload();
        }

        function showTxModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            txHashEl.innerHTML = '';
            txModal.style.display = 'flex';
        }

        function showNotification(message, type = 'success') {
            notificationEl.textContent = message;
            notificationEl.className = 'notification ' + type;
            notificationEl.style.display = 'block';
            
            setTimeout(() => {
                notificationEl.style.display = 'none';
            }, 5000);
        }

        // Make functions global for onclick handlers
        window.depositToPool = depositToPool;
        window.withdrawFromPool = withdrawFromPool;

        console.log('ENiAC Staking DApp ready');
    </script>
</body>
</html>